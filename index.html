<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Â§™Â≠ê„ÅÆ„ÅÇ„Åó„Åü - Â§™Â≠êÁî∫„ÅÆÂ≠ê„Å©„ÇÇ„Åü„Å°„ÅÆÁ¨ëÈ°î - presented by NPOÊ≥ï‰∫∫Âß´Ë∑ØYMCA</title>
    
    <!-- Favicon - NPOÊ≥ï‰∫∫Âß´Ë∑ØYMCA„É≠„Ç¥ -->
    <link rel="icon" type="image/png" href="https://page.gensparksite.com/v1/base64_upload/55b4c707311d7c5793d52e16c006746d">
    <link rel="shortcut icon" href="https://page.gensparksite.com/v1/base64_upload/55b4c707311d7c5793d52e16c006746d">
    <link rel="apple-touch-icon" href="https://page.gensparksite.com/v1/base64_upload/55b4c707311d7c5793d52e16c006746d">
    
    <!-- Performance Optimizations: DNS prefetch and preconnect -->
    <link rel="dns-prefetch" href="//unpkg.com">
    <link rel="dns-prefetch" href="//cdn.jsdelivr.net">
    <link rel="dns-prefetch" href="//images.unsplash.com">
    <link rel="preconnect" href="https://unpkg.com" crossorigin>
    <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
    
    <!-- Critical CSS - Custom styles first for fastest render -->
    <link rel="stylesheet" href="css/style.css">
    
    <!-- Leaflet CSS with fallback -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" 
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" 
          crossorigin=""
          onerror="console.error('‚ùå Failed to load Leaflet CSS from unpkg'); this.href='https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.min.css';"/>
    
    <!-- Font Awesome for icons - async loading -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" media="print" onload="this.media='all'">
    <noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css"></noscript>
    
    <!-- Preload critical resources -->
    <link rel="preload" href="data/areas.json" as="fetch" crossorigin>
    <link rel="preload" href="data/photos.json" as="fetch" crossorigin>
</head>
<body>
    <!-- Header - iOS style -->
    <header class="app-header" role="banner">
        <div class="header-content">
            <div class="header-left">
                <div class="header-logo">
                    <img src="https://page.gensparksite.com/v1/base64_upload/55b4c707311d7c5793d52e16c006746d" 
                         alt="NPOÊ≥ï‰∫∫Âß´Ë∑ØYMCA„É≠„Ç¥" 
                         class="ymca-logo"
                         loading="eager"
                         role="img"
                         aria-label="NPOÊ≥ï‰∫∫Âß´Ë∑ØYMCA - ÈÅãÂñ∂Âõ£‰Ωì„ÅÆ„É≠„Ç¥">
                </div>
                <div class="title-container">
                    <h1 id="headerTitle">Â§™Â≠ê„ÅÆ„ÅÇ„Åó„Åü</h1>
                    <p class="subtitle">presented by NPOÊ≥ï‰∫∫Âß´Ë∑ØYMCA</p>
                </div>
            </div>
            <div class="header-center">
                <!-- ‰∏≠Â§Æ„ÅØÁ©∫ÁôΩ -->
            </div>
            <div class="header-right">
                <a href="https://himeji-ymca.org/" target="_blank" rel="noopener noreferrer" class="organization-link" 
                   aria-label="NPOÊ≥ï‰∫∫Âß´Ë∑ØYMCA„ÅÆÈÅãÂñ∂Âõ£‰Ωì„Éö„Éº„Ç∏„ÇíÊñ∞„Åó„ÅÑ„Çø„Éñ„ÅßÈñã„Åè">
                    <span class="organization-text">ÈÅãÂñ∂Âõ£‰Ωì</span>
                    <i class="fas fa-external-link-alt" aria-hidden="true"></i>
                    <span class="sr-only">Â§ñÈÉ®„É™„É≥„ÇØ</span>
                </a>
            </div>
        </div>
    </header>

    <!-- Main Content - Map Only -->
    <main class="main-content" role="main">
        <!-- Map View -->
        <div id="mapView" class="view-container">
            <div id="map" class="map-container" role="application" aria-label="Â§™Â≠êÁî∫„Éï„Ç©„Éà„Éû„ÉÉ„Éó - „Éû„Éº„Ç´„Éº„Çí„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶ÂÜôÁúü„ÇíË°®Á§∫"></div>
            
            <!-- Map Controls -->
            <div class="map-controls">
                <button id="centerBtn" class="control-btn" title="‰∏≠ÂøÉ„Å´Êàª„Çã">
                    <i class="fas fa-crosshairs"></i>
                </button>
                <button id="addPhotoBtn" class="control-btn add-photo-btn" title="ÂÜôÁúü„ÇíËøΩÂä†">
                    <i class="fas fa-plus"></i>
                </button>
            </div>
            
            <!-- Area Info Panel -->
            <div id="areaInfoPanel" class="area-info-panel" style="display: none;">
                <div class="area-info-content">
                    <div class="area-header">
                        <div class="area-color-dot" id="areaColorDot"></div>
                        <h3 id="areaInfoName"></h3>
                        <button id="closeAreaInfo" class="close-btn">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <p id="areaInfoDescription"></p>
                    <div class="area-stats">
                        <div class="stat-item">
                            <i class="fas fa-camera"></i>
                            <span id="areaPhotoCount">0Êûö„ÅÆÂÜôÁúü</span>
                        </div>
                        <div class="stat-item">
                            <i class="fas fa-tag"></i>
                            <span id="areaCategory">„Ç´„ÉÜ„Ç¥„É™</span>
                        </div>
                        <div class="stat-item">
                            <i class="fas fa-clock"></i>
                            <span id="areaLastUpdate">ÊúÄÁµÇÊõ¥Êñ∞</span>
                        </div>
                    </div>
                    
                    <!-- Photo Filter Controls removed for simplicity -->
                    
                    <!-- üéØ Display Mode Controls -->
                    <div class="display-mode-controls">
                        <button id="gridModeBtn" class="mode-btn active">
                            <i class="fas fa-th"></i> „Ç∞„É™„ÉÉ„Éâ
                        </button>
                        <button id="timelineModeBtn" class="mode-btn">
                            <i class="fas fa-clock"></i> „Çø„Ç§„É†„É©„Ç§„É≥
                        </button>
                    </div>
                    
                    <!-- Grid View -->
                    <div class="area-photos-grid" id="areaPhotosGrid">
                        <!-- ÂÜôÁúü„Ç∞„É™„ÉÉ„Éâ„ÅåÂãïÁöÑ„Å´ËøΩÂä†„Åï„Çå„Çã -->
                    </div>
                    
                    <!-- üéØ Timeline View -->
                    <div class="area-photos-timeline" id="areaPhotosTimeline" style="display: none;">
                        <!-- „Çø„Ç§„É†„É©„Ç§„É≥Ë°®Á§∫„ÅåÂãïÁöÑ„Å´ËøΩÂä†„Åï„Çå„Çã -->
                    </div>
                    
                    <!-- Pagination -->
                    <div id="photoPagination" class="pagination" style="display: none;">
                        <button id="prevPage" class="pagination-btn">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <span id="pageInfo" class="page-info">1 / 1</span>
                        <button id="nextPage" class="pagination-btn">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                    
                    <div class="load-more-container">
                        <button id="loadMorePhotos" class="secondary-btn" style="display: none;">
                            „Åï„Çâ„Å´Ë™≠„ÅøËæº„ÇÄ
                        </button>
                        <div id="loadingPhotos" class="loading-indicator" style="display: none;">
                            <i class="fas fa-spinner fa-spin"></i>
                            Ë™≠„ÅøËæº„Åø‰∏≠...
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Photo Detail Modal -->
        <div id="photoModal" class="photo-modal" style="display: none;">
            <div class="modal-backdrop" id="modalBackdrop"></div>
            <div class="modal-content">
                <div class="modal-header">
                    <h3 id="modalPhotoTitle"></h3>
                    <button id="closeModal" class="close-btn">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="photo-container">
                        <img id="modalPhotoImage" src="" alt="">
                        <button id="prevModalPhoto" class="nav-btn prev" style="display: none;">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <button id="nextModalPhoto" class="nav-btn next" style="display: none;">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                    <div class="photo-info">
                        <p id="modalPhotoDescription"></p>
                        <div class="photo-meta">
                            <div class="meta-row">
                                <i class="fas fa-map-marker-alt"></i>
                                <span id="modalPhotoLocation"></span>
                            </div>
                            <div class="meta-row">
                                <i class="fas fa-clock"></i>
                                <span id="modalPhotoDate"></span>
                            </div>
                        </div>
                        <div id="modalPhotoTags" class="photo-tags">
                            <!-- „Çø„Ç∞„ÅåÂãïÁöÑ„Å´ËøΩÂä†„Åï„Çå„Çã -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Add Photo Modal -->
        <div id="addPhotoModal" class="photo-modal" style="display: none;">
            <div class="modal-backdrop" id="addPhotoBackdrop"></div>
            <div class="modal-content add-photo-modal">
                <div class="modal-header">
                    <h3>Êñ∞„Åó„ÅÑÂÜôÁúü„ÇíËøΩÂä†</h3>
                    <button id="closeAddPhotoModal" class="close-btn">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="addPhotoForm" class="add-photo-form">
                        <div class="form-group">
                            <label for="photoTitle">„Çø„Ç§„Éà„É´ *</label>
                            <input type="text" id="photoTitle" name="title" required placeholder="ÂÜôÁúü„ÅÆ„Çø„Ç§„Éà„É´„ÇíÂÖ•Âäõ">
                        </div>
                        <div class="form-group">
                            <label for="photoDescription">Ë™¨Êòé</label>
                            <textarea id="photoDescription" name="description" rows="3" placeholder="ÂÜôÁúü„ÅÆË™¨Êòé„ÇíÂÖ•ÂäõÔºàÁúÅÁï•ÂèØÔºâ"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="photoImageUrl">ÁîªÂÉèURL *</label>
                            <input type="url" id="photoImageUrl" name="image_url" required placeholder="https://example.com/image.jpg">
                            <small>Unsplash„Å™„Å©„ÅÆÂÜôÁúüURL„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ</small>
                        </div>
                        <div class="form-group">
                            <label for="photoLocation">Â†¥ÊâÄ</label>
                            <input type="text" id="photoLocation" name="location" placeholder="ÊíÆÂΩ±Â†¥ÊâÄ„ÇíÂÖ•Âäõ">
                        </div>
                        <div class="form-group">
                            <label for="photoTags">„Çø„Ç∞</label>
                            <input type="text" id="photoTags" name="tags" placeholder="„Çø„Ç∞„Çí„Ç´„É≥„ÉûÂå∫Âàá„Çä„ÅßÂÖ•ÂäõÔºà‰æã: È¢®ÊôØ,Ëá™ÁÑ∂,Â§ïÊó•Ôºâ">
                        </div>
                        <div class="form-group">
                            <label>‰ΩçÁΩÆÊÉÖÂ†±</label>
                            <div class="location-info">
                                <span>Á∑ØÂ∫¶: <span id="selectedLat">--</span></span>
                                <span>ÁµåÂ∫¶: <span id="selectedLng">--</span></span>
                                <button type="button" id="selectLocationBtn" class="location-btn">
                                    <i class="fas fa-map-marker-alt"></i> Âú∞Âõ≥„Åß‰ΩçÁΩÆ„ÇíÈÅ∏Êäû
                                </button>
                            </div>
                        </div>
                        <div class="form-actions">
                            <button type="button" id="cancelAddPhoto" class="secondary-btn">„Ç≠„É£„É≥„Çª„É´</button>
                            <button type="submit" id="submitAddPhoto" class="primary-btn">ÂÜôÁúü„ÇíËøΩÂä†</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Location Selection Indicator -->
        <div id="locationMarker" class="location-marker" style="display: none;">
            <i class="fas fa-map-marker-alt"></i>
        </div>
    </main>



    <!-- Loading overlay with progress -->
    <div id="loadingOverlay" class="loading-overlay" role="dialog" aria-labelledby="loading-title" aria-describedby="loading-desc">
        <div class="loading-spinner">
            <div class="loading-logo">
                <img src="https://page.gensparksite.com/v1/base64_upload/55b4c707311d7c5793d52e16c006746d" 
                     alt="NPOÊ≥ï‰∫∫Âß´Ë∑ØYMCA„É≠„Ç¥" 
                     class="loading-ymca-logo"
                     loading="eager">
            </div>
            <i class="fas fa-spinner fa-spin" aria-hidden="true"></i>
            <h2 id="loading-title">„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Åø‰∏≠...</h2>
            <p id="loading-desc">Â§™Â≠êÁî∫„ÅÆÊú™Êù•„ÅÆÁû¨Èñì„ÇíÊ∫ñÂÇô„Åó„Å¶„ÅÑ„Åæ„Åô</p>
            <div class="progress-container" aria-hidden="true">
                <div class="progress-bar">
                    <div id="progressFill" class="progress-fill"></div>
                </div>
                <div id="progressText" class="progress-text">0%</div>
            </div>
            <div id="loadingSteps" class="loading-steps">
                <div class="loading-step" id="step-data">
                    <i class="fas fa-circle-notch fa-spin"></i>
                    <span>„Éá„Éº„ÇøË™≠„ÅøËæº„Åø‰∏≠...</span>
                </div>
                <div class="loading-step" id="step-map">
                    <i class="fas fa-circle"></i>
                    <span>Âú∞Âõ≥„ÇíÊ∫ñÂÇô‰∏≠...</span>
                </div>
                <div class="loading-step" id="step-images">
                    <i class="fas fa-circle"></i>
                    <span>ÁîªÂÉè„ÇíÊ∫ñÂÇô‰∏≠...</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Performance optimized JavaScript loading -->
    <script>
        // Performance monitoring
        const perfStart = performance.now();
        console.log('‚è±Ô∏è „Éö„Éº„Ç∏„É≠„Éº„ÉâÈñãÂßã:', perfStart);

        // Preload modules for faster execution
        const modulePreloadLinks = [
            'js/config/constants.js',
            'js/utils/EventEmitter.js',
            'js/utils/ErrorHandler.js',
            'js/utils/ImageHandler.js',
            'js/modules/DataManager.js',
            'js/modules/MapManager.js',
            'js/modules/MarkerManager.js',
            'js/modules/UIManager.js'
        ];

        modulePreloadLinks.forEach(href => {
            const link = document.createElement('link');
            link.rel = 'modulepreload';
            link.href = href;
            document.head.appendChild(link);
        });

        // Optimized Leaflet loading with async/defer strategy
        function loadLeafletFallback() {
            console.log('üîÑ Loading Leaflet fallback from jsDelivr...');
            const script = document.createElement('script');
            script.src = 'https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.min.js';
            script.async = true;
            script.onload = () => {
                console.log('‚úÖ Leaflet fallback loaded successfully');
                initializeApp();
            };
            script.onerror = () => {
                console.error('‚ùå Leaflet fallback also failed');
                showFallbackMessage();
            };
            document.head.appendChild(script);
        }

        function showFallbackMessage() {
            const loadingOverlay = document.getElementById('loadingOverlay');
            if (loadingOverlay) {
                loadingOverlay.innerHTML = `
                    <div class="loading-spinner">
                        <i class="fas fa-exclamation-triangle" style="color: #ff6b6b;"></i>
                        <h3>Ë™≠„ÅøËæº„Åø„Ç®„É©„Éº</h3>
                        <p>Âú∞Âõ≥„É©„Ç§„Éñ„É©„É™„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ</p>
                        <button onclick="location.reload()" style="padding: 10px 20px; margin-top: 10px; background: #007aff; color: white; border: none; border-radius: 6px; cursor: pointer;">
                            ÂÜçË™≠„ÅøËæº„Åø
                        </button>
                    </div>
                `;
            }
        }

        let appInitialized = false;
        function initializeApp() {
            if (appInitialized) return;
            appInitialized = true;
            
            // Load main application
            console.log('üöÄ Starting app module import...');
            import('./js/app-refactored.js').then((module) => {
                const perfEnd = performance.now();
                console.log(`‚úÖ „Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥Ë™≠„ÅøËæº„ÅøÂÆå‰∫Ü: ${(perfEnd - perfStart).toFixed(2)}ms`);
                console.log('üì¶ Module loaded:', module);
            }).catch(error => {
                console.error('‚ùå „Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥Ë™≠„ÅøËæº„Åø„Ç®„É©„Éº:', error);
                console.error('‚ùå Error stack:', error.stack);
                showFallbackMessage();
            });
        }
    </script>
    
    <!-- Leaflet JavaScript with performance optimization -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" 
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" 
            crossorigin=""
            async
            onload="console.log('‚úÖ Leaflet loaded from unpkg'); initializeApp();"
            onerror="console.error('‚ùå Failed to load Leaflet from unpkg'); loadLeafletFallback();"></script>
    
    <!-- Timeout fallback for slow connections -->
    <script>
        setTimeout(() => {
            if (typeof L === 'undefined' && !appInitialized) {
                console.warn('‚ö†Ô∏è Leaflet loading timeout (5s), trying fallback...');
                loadLeafletFallback();
            }
        }, 5000);
    </script>
    
    <!-- Fallback for old version (comment out when testing new version) -->
    <!-- <script src="js/app.js"></script> -->
</body>
</html>